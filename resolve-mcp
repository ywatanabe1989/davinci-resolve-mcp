#!/usr/bin/env bash
# DaVinci Resolve MCP Server - Universal Entry Point
# Works on macOS, Windows (Git Bash), and WSL
#
# Usage:
#   ./resolve-mcp           # Start MCP server
#   ./resolve-mcp --help    # Show help
#   ./resolve-mcp --check   # Check if Resolve is running

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() { echo -e "${GREEN}[INFO]${NC} $1" >&2; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1" >&2; }
log_error() { echo -e "${RED}[ERROR]${NC} $1" >&2; }

# Detect platform
detect_platform() {
    case "$(uname -s)" in
        Darwin)
            echo "macos"
            ;;
        Linux)
            if grep -qiE "(microsoft|wsl)" /proc/version 2>/dev/null; then
                echo "wsl"
            else
                echo "linux"
            fi
            ;;
        MINGW*|MSYS*|CYGWIN*)
            echo "windows"
            ;;
        *)
            echo "unknown"
            ;;
    esac
}

show_help() {
    cat << 'EOF'
DaVinci Resolve MCP Server

USAGE:
    ./resolve-mcp [OPTIONS]

OPTIONS:
    --help      Show this help message
    --check     Check if DaVinci Resolve is running
    --verbose   Show detailed output

PLATFORMS:
    macOS       Runs natively
    Windows     Use from Git Bash or run resolve-mcp.bat
    WSL         Bridges to Windows DaVinci Resolve automatically

SETUP:
    1. Install DaVinci Resolve on your system
    2. Enable external scripting in Resolve preferences:
       Preferences → System → General → External scripting using: Local
    3. Run: ./resolve-mcp

CLAUDE CODE CONFIG (~/.claude.json):
    {
      "mcpServers": {
        "davinci-resolve": {
          "command": "/path/to/davinci-resolve-mcp/resolve-mcp",
          "args": []
        }
      }
    }

EOF
}

check_resolve_running() {
    local platform="$1"
    case "$platform" in
        macos)
            pgrep -x "DaVinci Resolve" > /dev/null 2>&1
            ;;
        wsl|windows)
            # Use </dev/null to prevent stdin consumption (critical for MCP stdio)
            powershell.exe -NoProfile -Command "Get-Process -Name 'Resolve' -ErrorAction SilentlyContinue" </dev/null 2>/dev/null | grep -q "Resolve"
            ;;
        linux)
            pgrep -f "resolve" > /dev/null 2>&1
            ;;
    esac
}

run_macos() {
    log_info "Running on macOS"

    # Set environment
    export RESOLVE_SCRIPT_API="/Library/Application Support/Blackmagic Design/DaVinci Resolve/Developer/Scripting"
    export RESOLVE_SCRIPT_LIB="/Applications/DaVinci Resolve/DaVinci Resolve.app/Contents/Libraries/Fusion/fusionscript.so"
    export PYTHONPATH="${PYTHONPATH}:${RESOLVE_SCRIPT_API}/Modules/"

    # Use venv if exists, otherwise system python
    if [ -f "$SCRIPT_DIR/venv/bin/python" ]; then
        exec "$SCRIPT_DIR/venv/bin/python" -m src
    else
        exec python3 "$SCRIPT_DIR/src/__main__.py"
    fi
}

run_wsl() {
    log_info "Running on WSL (bridging to Windows)"

    # Use the Python entry point for WSL
    exec python3 "$SCRIPT_DIR/scripts/linux/mcp_entry.py" "$@"
}

run_linux() {
    log_info "Running on Linux"
    log_warn "DaVinci Resolve must be running on this machine"

    # Use venv if exists
    if [ -f "$SCRIPT_DIR/venv/bin/python" ]; then
        exec "$SCRIPT_DIR/venv/bin/python" -m src
    else
        exec python3 "$SCRIPT_DIR/src/__main__.py"
    fi
}

run_windows() {
    log_error "Please use resolve-mcp.bat on Windows"
    log_info "Or run from Git Bash/WSL"
    exit 1
}

main() {
    # Parse arguments
    case "${1:-}" in
        --help|-h)
            show_help
            exit 0
            ;;
        --check)
            PLATFORM=$(detect_platform)
            if check_resolve_running "$PLATFORM"; then
                log_info "DaVinci Resolve is running"
                exit 0
            else
                log_error "DaVinci Resolve is not running"
                exit 1
            fi
            ;;
        --verbose|-v)
            export VERBOSE=1
            shift
            ;;
    esac

    PLATFORM=$(detect_platform)
    log_info "Detected platform: $PLATFORM"

    # Check if Resolve is running
    if ! check_resolve_running "$PLATFORM"; then
        log_warn "DaVinci Resolve does not appear to be running"
        log_info "Please start DaVinci Resolve first"
        log_info "Make sure external scripting is enabled in Preferences"
    fi

    # Run platform-specific code
    case "$PLATFORM" in
        macos)
            run_macos "$@"
            ;;
        wsl)
            run_wsl "$@"
            ;;
        linux)
            run_linux "$@"
            ;;
        windows)
            run_windows "$@"
            ;;
        *)
            log_error "Unknown platform: $PLATFORM"
            exit 1
            ;;
    esac
}

main "$@"
