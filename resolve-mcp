#!/usr/bin/env bash
# DaVinci Resolve MCP Server - Universal Entry Point
# Works on macOS, Windows (Git Bash), and WSL
#
# Usage:
#   ./resolve-mcp           # Start MCP server
#   ./resolve-mcp --help    # Show help
#   ./resolve-mcp --check   # Check if Resolve is running

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Detect platform
detect_platform() {
    case "$(uname -s)" in
        Darwin)
            echo "macos"
            ;;
        Linux)
            if grep -qiE "(microsoft|wsl)" /proc/version 2>/dev/null; then
                echo "wsl"
            else
                echo "linux"
            fi
            ;;
        MINGW*|MSYS*|CYGWIN*)
            echo "windows"
            ;;
        *)
            echo "unknown"
            ;;
    esac
}

show_help() {
    cat << 'EOF'
DaVinci Resolve MCP Server

USAGE:
    ./resolve-mcp [OPTIONS]

OPTIONS:
    --help      Show this help message
    --check     Check if DaVinci Resolve is running
    --test      Test the setup without starting server
    --verbose   Show detailed output

PLATFORMS:
    macOS       Runs natively
    Windows     Use from Git Bash or run resolve-mcp.bat
    WSL         Bridges to Windows DaVinci Resolve automatically

SETUP:
    1. Install DaVinci Resolve on your system
    2. Enable external scripting in Resolve preferences:
       Preferences → System → General → External scripting using: Local
    3. Run: ./resolve-mcp

CLAUDE CODE CONFIG (~/.claude.json):
    {
      "mcpServers": {
        "davinci-resolve": {
          "command": "/path/to/davinci-resolve-mcp/resolve-mcp",
          "args": []
        }
      }
    }

EOF
}

check_resolve_running() {
    local platform="$1"
    case "$platform" in
        macos)
            pgrep -x "DaVinci Resolve" > /dev/null 2>&1
            ;;
        wsl|windows)
            powershell.exe -NoProfile -Command "Get-Process -Name 'Resolve' -ErrorAction SilentlyContinue" 2>/dev/null | grep -q "Resolve"
            ;;
        linux)
            pgrep -f "resolve" > /dev/null 2>&1
            ;;
    esac
}

run_macos() {
    log_info "Running on macOS"

    # Set environment
    export RESOLVE_SCRIPT_API="/Library/Application Support/Blackmagic Design/DaVinci Resolve/Developer/Scripting"
    export RESOLVE_SCRIPT_LIB="/Applications/DaVinci Resolve/DaVinci Resolve.app/Contents/Libraries/Fusion/fusionscript.so"
    export PYTHONPATH="${PYTHONPATH}:${RESOLVE_SCRIPT_API}/Modules/"

    # Use venv if exists, otherwise system python
    if [ -f "$SCRIPT_DIR/venv/bin/python" ]; then
        exec "$SCRIPT_DIR/venv/bin/python" -m src
    else
        exec python3 "$SCRIPT_DIR/src/__main__.py"
    fi
}

test_wsl_setup() {
    log_info "Testing WSL setup..."

    # Check PowerShell
    if ! command -v powershell.exe &> /dev/null; then
        log_error "powershell.exe not found in PATH"
        return 1
    fi
    log_info "✓ PowerShell available"

    # Check Resolve running
    if powershell.exe -NoProfile -Command "Get-Process -Name 'Resolve' -ErrorAction SilentlyContinue" 2>/dev/null | grep -q "Resolve"; then
        log_info "✓ DaVinci Resolve is running"
    else
        log_error "✗ DaVinci Resolve is NOT running"
        log_info "  Start DaVinci Resolve on Windows first"
        return 1
    fi

    # Check if project has Windows venv
    local win_venv="$SCRIPT_DIR/.venv_win"
    if [ -d "$win_venv" ]; then
        log_info "✓ Windows venv found at .venv_win/"
    else
        log_warn "✗ No Windows venv at .venv_win/"
        log_info "  For WSL, you need Python installed on Windows:"
        log_info "  1. Open PowerShell"
        log_info "  2. cd to this project (via /mnt/c/... path)"
        log_info "  3. python -m venv .venv_win"
        log_info "  4. .venv_win\\Scripts\\pip install -r requirements.txt"
    fi

    log_info ""
    log_info "WSL bridges to Windows Python to access DaVinci Resolve API."
    log_info "The MCP server runs in stdio mode (waits for JSON-RPC input)."
    log_info ""
    log_info "To use with Claude Code, add to ~/.claude.json:"
    log_info "  {\"mcpServers\": {\"davinci-resolve\": {"
    log_info "    \"command\": \"$SCRIPT_DIR/resolve-mcp\","
    log_info "    \"args\": []}}}"
}

run_wsl() {
    log_info "Running on WSL (bridging to Windows)"
    log_info "Starting MCP server (stdio mode - will wait for client)..."

    # Use the Python entry point for WSL
    exec python3 "$SCRIPT_DIR/scripts/linux/mcp_entry.py" "$@"
}

run_linux() {
    log_info "Running on Linux"
    log_warn "DaVinci Resolve must be running on this machine"

    # Use venv if exists
    if [ -f "$SCRIPT_DIR/venv/bin/python" ]; then
        exec "$SCRIPT_DIR/venv/bin/python" -m src
    else
        exec python3 "$SCRIPT_DIR/src/__main__.py"
    fi
}

run_windows() {
    log_error "Please use resolve-mcp.bat on Windows"
    log_info "Or run from Git Bash/WSL"
    exit 1
}

main() {
    # Parse arguments
    case "${1:-}" in
        --help|-h)
            show_help
            exit 0
            ;;
        --check)
            PLATFORM=$(detect_platform)
            if check_resolve_running "$PLATFORM"; then
                log_info "DaVinci Resolve is running"
                exit 0
            else
                log_error "DaVinci Resolve is not running"
                exit 1
            fi
            ;;
        --test)
            PLATFORM=$(detect_platform)
            log_info "Detected platform: $PLATFORM"
            case "$PLATFORM" in
                wsl)
                    test_wsl_setup
                    ;;
                *)
                    log_info "Test mode only implemented for WSL currently"
                    check_resolve_running "$PLATFORM" && log_info "✓ DaVinci Resolve is running" || log_error "✗ DaVinci Resolve is NOT running"
                    ;;
            esac
            exit 0
            ;;
        --verbose|-v)
            export VERBOSE=1
            shift
            ;;
    esac

    PLATFORM=$(detect_platform)
    log_info "Detected platform: $PLATFORM"

    # Check if Resolve is running
    if ! check_resolve_running "$PLATFORM"; then
        log_warn "DaVinci Resolve does not appear to be running"
        log_info "Please start DaVinci Resolve first"
        log_info "Make sure external scripting is enabled in Preferences"
    fi

    # Run platform-specific code
    case "$PLATFORM" in
        macos)
            run_macos "$@"
            ;;
        wsl)
            run_wsl "$@"
            ;;
        linux)
            run_linux "$@"
            ;;
        windows)
            run_windows "$@"
            ;;
        *)
            log_error "Unknown platform: $PLATFORM"
            exit 1
            ;;
    esac
}

main "$@"
